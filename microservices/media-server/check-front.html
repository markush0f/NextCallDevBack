<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Test WebSocket Gateway</title>
</head>
<body>
  <h2>Test WebSocket a trav√©s del API Gateway</h2>

  <button onclick="sendGetRtpCapabilities()">Obtener RTP Capabilities</button>
  <button onclick="sendCreateTransport()">Crear WebRTC Transport</button>
  <button onclick="sendConnectTransport()">Conectar WebRTC Transport</button>

  <pre id="log"></pre>

  <script>
    const meetingId = 1;
    const userId = 1;
    const socket = new WebSocket("ws://localhost:8084/ws/meeting/1/1");

    let lastTransportId = null; // ‚ö° Guardar el transportId despu√©s de crearlo

    socket.onopen = () => {
      log("üü¢ WebSocket conectado (v√≠a API Gateway)");

      // Enviar mensaje de prueba autom√°ticamente
      sendGetRtpCapabilities();
    };

    socket.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);
        log("üì© Respuesta del servidor:\n" + JSON.stringify(data, null, 2));

        if (data.action === "create-transport" && data.data.id) {
          lastTransportId = data.data.id;
          log("‚úÖ Transport creado y guardado: " + lastTransportId);
        }
      } catch (err) {
        log("‚ùå Mensaje no es JSON v√°lido:\n" + event.data);
      }
    };

    socket.onerror = (err) => {
      log("‚ùå Error WebSocket: " + err.message);
    };

    socket.onclose = () => {
      log("üî¥ Conexi√≥n cerrada");
    };

    function sendGetRtpCapabilities() {
      if (socket.readyState !== WebSocket.OPEN) {
        log("‚ö†Ô∏è WebSocket a√∫n no est√° listo");
        return;
      }

      const message = {
        type: "get-rtp-capabilities",
        sender: userId,
        target: 0,
        payload: {}
      };

      socket.send(JSON.stringify(message));
      log("üì§ Enviado: get-rtp-capabilities");
    }

    function sendCreateTransport() {
      if (socket.readyState !== WebSocket.OPEN) {
        log("‚ö†Ô∏è WebSocket a√∫n no est√° listo");
        return;
      }

      const message = {
        type: "create-transport",
        sender: userId,
        target: 0,
        payload: {}
      };

      socket.send(JSON.stringify(message));
      log("üì§ Enviado: create-transport");
    }

    function sendConnectTransport() {
      if (socket.readyState !== WebSocket.OPEN) {
        log("‚ö†Ô∏è WebSocket a√∫n no est√° listo");
        return;
      }

      if (!lastTransportId) {
        log("‚ö†Ô∏è No hay transportId creado todav√≠a");
        return;
      }

      const fakeDtlsParameters = {
        fingerprints: [
          {
            algorithm: "sha-256",
            value: "00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00"
          }
        ],
        role: "auto"
      };

      const message = {
        type: "connect-transport",
        sender: userId,
        target: 0,
        payload: {
          transportId: lastTransportId,
          dtlsParameters: fakeDtlsParameters
        }
      };

      socket.send(JSON.stringify(message));
      log("üì§ Enviado: connect-transport");
    }

    function log(text) {
      const logElement = document.getElementById("log");
      logElement.textContent += text + "\n";
    }
  </script>
</body>
</html>
